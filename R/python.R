
renv_python_snapshot <- function() {

  python <- renv_state$python()
  if (is.null(python))
    return(NULL)

  renv_python_pip_freeze()

}

renv_python_restore <- function(lockfile) {

  python <- renv_state$python()
  if (is.null(python))
    return(NULL)

  requirements <- lockfile$Python$Requirements
  renv_python_pip_restore(requirements = requirements)

}

renv_python_blueprint_resolve <- function(python) {

  python <- case(
    is.null(python)          ~ NULL,
    identical(python, FALSE) ~ NULL,
    identical(python, TRUE)  ~ Sys.which("python"),
    as.character(python)
  )

  python %&&% list(Path = python)

}

renv_python_virtualenv_root <- function() {
  Sys.getenv("WORKON_HOME", unset = path.expand("~/.virtualenvs"))
}

renv_python_resolve <- function(python) {

  # if the user has requested a virtual environment by name, provide it
  if (!grepl("[/\\]", python)) {
    virtualenv <- file.path(renv_python_virtualenv_root(), python)
    if (renv_file_exists(virtualenv))
      python <- virtualenv
  }

  # if the requested path doesn't exist, just return it (upstream
  # will warn appropriately)
  info <- file.info(python, extra_cols = FALSE)
  if (is.na(info$isdir))
    return(python)

  # if python points to a plain file, then assume we received the
  # path to a Python binary
  if (identical(info$isdir, FALSE))
    return(python)

  # otherwise, we received a directory; assume this is the root
  # for a virtualenv and provide the associated Python
  if (Sys.info()[["sysname"]] == "Windows")
    file.path(python, "Scripts/python.exe")
  else
    file.path(python, "bin/python")

}

renv_python_pip_freeze <- function(python = NULL) {
  python <- python %||% renv_state$python()
  args <- c("-m", "pip", "freeze")
  output <- system2(python, args, stdout = TRUE)
  renv_read_properties(text = output, delimiter = "==")
}

renv_python_pip_restore <- function(python = NULL, requirements) {

  # write requirements out to file
  text <- paste(names(requirements), requirements, sep = "==")
  file <- tempfile("requirements-", fileext = ".txt")
  writeLines(text, con = file)
  on.exit(unlink(file), add = TRUE)

  python <- python %||% renv_state$python()
  args <- c("-m", "pip", "install", "-r", shQuote(file))
  system2(python, args)

}
